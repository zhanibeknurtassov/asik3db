<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Simple CRUD Frontend</title>
</head>
<body>
<h1>Database Tables</h1>

<div id="tables"></div>

<script>
const apiBase = "http://localhost:5000";
const tableNames = ["USER", "CAREGIVER", "MEMBER", "ADDRESS", "JOB", "JOB_APPLICATION", "APPOINTMENT"];

// Optional: map primary key columns per table
const pkColumns = {
    USER: "user_id",
    CAREGIVER: "caregiver_user_id",
    MEMBER: "member_user_id",
    ADDRESS: "member_user_id",
    JOB: "job_id",
    JOB_APPLICATION: "job_application_id",
    APPOINTMENT: "appointment_id"
};

document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("tables");
    tableNames.forEach(name => loadTable(name, container));
});

async function loadTable(tableName, container) {
    const wrapper = document.createElement("div");
    wrapper.innerHTML = `<h2>${tableName}</h2>`;
    container.appendChild(wrapper);

    const tableEl = document.createElement("table");
    tableEl.border = 1;
    wrapper.appendChild(tableEl);

    // create form container
    const formContainer = document.createElement("div");
    formContainer.innerHTML = `<p>Create new ${tableName}</p>`;
    wrapper.appendChild(formContainer);

    async function loadRows() {
        const res = await fetch(`${apiBase}/${tableName}`);
        const rows = await res.json();

        tableEl.innerHTML = "";

        if (rows.length === 0) {
            tableEl.innerHTML = "<tr><td>No rows</td></tr>";
            return;
        }

        // Build table header
        const header = document.createElement("tr");
        Object.keys(rows[0]).forEach(col => {
            const th = document.createElement("th");
            th.innerText = col;
            header.appendChild(th);
        });
        header.innerHTML += "<th>Actions</th>";
        tableEl.appendChild(header);

        // Build form for creating new row
        formContainer.innerHTML = "<p>Create new " + tableName + "</p>";
        const formEl = document.createElement("table");
        formEl.border = 1;
        const formRow = document.createElement("tr");
        Object.keys(rows[0]).forEach(col => {
            // For CAREGIVER, always include caregiver_user_id
            if (tableName === "CAREGIVER" && col === "caregiver_user_id") {
                const td = document.createElement("td");
                const input = document.createElement("input");
                input.placeholder = "caregiver_user_id (user_id from USER)";
                input.name = col;
                td.appendChild(input);
                formRow.appendChild(td);
                return; // done with this col
            }
            if (tableName === "MEMBER" && col === "member_user_id") {
                const td = document.createElement("td");
                const input = document.createElement("input");
                input.placeholder = "member_user_id (user_id from USER)";
                input.name = col;
                td.appendChild(input);
                formRow.appendChild(td);
                return; // done with this col
            }
            if (tableName === "ADDRESS" && col === "member_user_id") {
                const td = document.createElement("td");
                const input = document.createElement("input");
                input.placeholder = "member_user_id";
                input.name = col;
                td.appendChild(input);
                formRow.appendChild(td);
                return; // done with this col
            }
            if (tableName === "JOB" && col === "member_user_id") {
                const td = document.createElement("td");
                const input = document.createElement("input");
                input.placeholder = "member_user_id (from MEMBER)";
                input.name = col;
                td.appendChild(input);
                formRow.appendChild(td);
                return; // done with this col
            }
            if (tableName === "APPOINTMENT" && col === "member_user_id") {
                const td = document.createElement("td");
                const input = document.createElement("input");
                input.placeholder = "member_user_id (from MEMBER)";
                input.name = col;
                td.appendChild(input);
                formRow.appendChild(td);
                return; // done with this col
            }

            // Skip other PK columns that auto-increment
            if (col === pkColumns[tableName]) return;

            const td = document.createElement("td");
            const input = document.createElement("input");
            input.placeholder = col;
            input.name = col;
            td.appendChild(input);
            formRow.appendChild(td);
        });
        const submitTd = document.createElement("td");
        const submitBtn = document.createElement("button");
        submitBtn.innerText = "Create";
        submitBtn.onclick = async () => {
            const inputs = formRow.querySelectorAll("input");
            const data = {};
            inputs.forEach(i => {
                if (i.value !== "") data[i.name] = i.value;
            });
            await fetch(`${apiBase}/${tableName}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            loadRows();
        };
        submitTd.appendChild(submitBtn);
        formRow.appendChild(submitTd);
        formEl.appendChild(formRow);
        formContainer.appendChild(formEl);

        // Populate table rows
        rows.forEach(row => {
            const tr = document.createElement("tr");
            Object.values(row).forEach(val => {
                const td = document.createElement("td");
                td.innerText = val;
                tr.appendChild(td);
            });

            const pkName = pkColumns[tableName] || Object.keys(row)[0];
            const pk = row[pkName];

            const actions = document.createElement("td");

            // Update button
            const updateBtn = document.createElement("button");
            updateBtn.innerText = "Update";
            updateBtn.onclick = () => {
                const newVal = prompt("Enter JSON to update row", JSON.stringify(row));
                if (!newVal) return;
                try {
                    const obj = JSON.parse(newVal);
                    fetch(`${apiBase}/${tableName}/${pk}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(obj)
                    }).then(loadRows);
                } catch(err) { alert("Invalid JSON"); }
            };
            actions.appendChild(updateBtn);

            // Delete button
            const delBtn = document.createElement("button");
            delBtn.innerText = "Delete";
            delBtn.onclick = () => {
                fetch(`${apiBase}/${tableName}/${pk}`, { method: "DELETE" }).then(loadRows);
            };
            actions.appendChild(delBtn);

            tr.appendChild(actions);
            tableEl.appendChild(tr);
        });
    }

    loadRows();
}
</script>
</body>
</html>
